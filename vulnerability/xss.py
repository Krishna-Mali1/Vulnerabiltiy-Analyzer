#!/usr/bin/env python
from vulnerability.crawl import Crawl


class XSS(Crawl):
    def run_program(self):
        for link in self.target_link:
            forms = self.extract_fourms(link)
            for form in forms:
                print("[+] Testing form in "+ link)
                is_vulnerable_to_xss = self.test_xss_form(form,link)
                if is_vulnerable_to_xss:
                    print("\n\n[***] XSS discovered in "+link+" in the following form")
                    print(form)

                if "=" in link:
                    print("\n\n[+] Testing " + link)
                    is_vulnerable_to_xss = self.test_xss_url(link)
                    if is_vulnerable_to_xss:
                        print("\n\n[***] XSS discovered in " + link)

    def test_xss_url(self,url):
        xss_test_script = "<sCript>alert('test')</scriPt>"
        url = url.replace("=","=" + xss_test_script)
        response = self.session.get(url)
        return xss_test_script in response.content.decode(errors="ignore")

    def test_xss_form(self,form,url):
        xss_test_script = "<sCript>alert('test')</scRipt>"
        response = self.submit_form(form,xss_test_script,url)
        return xss_test_script in response.content.decode(errors="ignore")